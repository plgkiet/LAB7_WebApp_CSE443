@{
    Layout = "AdminLayout";
}

<h2 class="page-title">üë• User Manager</h2>

<div class="btn-group">
    <button id="btnLoad" class="btn btn-primary">üîÑ Load Users</button>
</div>

<table id="usersTable" class="users-table">
    <thead>
    <tr>
        <th>Full Name</th>
        <th>Username</th>
        <th>Email</th>
        <th>Phone</th>
        <th>Address</th>
        <th>Created Date</th>
        <th>Avatar</th>
        <th style="width: 150px;">Actions</th>
    </tr>
    </thead>
    <tbody>
    <tr><td colspan="5" style="text-align:center;">Loading users...</td></tr>
    </tbody>
</table>

<div class="add-user-form">
    <div class="form-group">
        <label for="fullnameInput">Full Name</label>
        <input type="text" id="fullnameInput" placeholder="Enter full name" />
    </div>

    <div class="form-group">
        <label for="usernameInput">Username</label>
        <input type="text" id="usernameInput" placeholder="Enter username" />
    </div>

    <div class="form-group">
        <label for="emailInput">Email</label>
        <input type="email" id="emailInput" placeholder="Enter email" />
    </div>

    <div class="form-group">
        <label for="passwordInput">Password</label>
        <input type="password" id="passwordInput" placeholder="Enter password" />
    </div>


    <div class="form-group">
        <label for="phoneInput">Phone</label>
        <input type="text" id="phoneInput" placeholder="Enter phone number" />
    </div>

    <div class="form-group">
        <label for="addressInput">Address</label>
        <input type="text" id="addressInput" placeholder="Enter address" />
    </div>

    <div class="form-group">
        <label for="avatarInput">Avatar URL</label>
        <input type="text" id="avatarInput" placeholder="Enter avatar URL" />
    </div>

    <div class="form-group" style="align-self: end;">
        <button id="btnSubmitAdd" class="btn btn-success">Add User</button>
    </div>
</div>

<div id="message" class="message"></div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(function () {
            function showMessage(text, isError = false) {
                var msgDiv = $("#message");
                msgDiv.text(text);
                msgDiv.css({
                    color: isError ? "#dc3545" : "#28a745",
                    opacity: 1
                });
                setTimeout(() => {
                    msgDiv.css("opacity", 0);
                }, 3000);
            }

            function loadUsers() {
                $("#usersTable tbody").html("<tr><td colspan='9' style='text-align:center;'>Loading users...</td></tr>");
                $.ajax({
                    url: "/api/Users",
                    type: "GET",
                    success: function (data) {
                        if (data.length === 0) {
                            $("#usersTable tbody").html("<tr><td colspan='9' style='text-align:center;'>No users found.</td></tr>");
                            return;
                        }
                        var rows = "";
                        data.forEach(function (user) {
                            rows += "<tr>" +
                                "<td>" + user.fullname + "</td>" +
                                "<td>" + user.username + "</td>" +
                                "<td>" + user.email + "</td>" +
                                "<td>" + user.phone + "</td>" +
                                "<td>" + user.address + "</td>" +
                                "<td>" + user.createdDate + "</td>" +
                                "<td>" + user.avatar + "</td>" +
                                "<td>" +
                                "<button class='btnEdit' data-id='" + user.userId + "'>‚úèÔ∏è Edit</button>" +
                                "<button class='btnDelete' data-id='" + user.userId + "'>üóë Delete</button>" +
                                "</td>" +
                                "</tr>";
                        });
                        $("#usersTable tbody").html(rows);
                    },
                    error: function () {
                        $("#usersTable tbody").html("<tr><td colspan='9' style='text-align:center; color:red;'>Error loading users.</td></tr>");
                        showMessage("Error loading users", true);
                    }
                });
            }

            $("#btnLoad").click(loadUsers);

            $("#btnSubmitAdd").click(function () {
                var newUser = {
                    fullname: $("#fullnameInput").val().trim(),
                    username: $("#usernameInput").val().trim(),
                    email: $("#emailInput").val().trim(),
                    password: $("#passwordInput").val(),  // th√™m password v√†o ƒë√¢y
                    phone: $("#phoneInput").val().trim(),
                    address: $("#addressInput").val().trim(),
                    avatar: $("#avatarInput").val().trim(),
                    createdDate: new Date().toISOString().slice(0, 10) // format yyyy-mm-dd
                };

                if (!newUser.username || !newUser.email || !newUser.fullname) {
                    showMessage("Fullname, Username and Email are required", true);
                    return;
                }

                $.ajax({
                    url: "/api/Users",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(newUser),
                    success: function () {
                        showMessage("User added successfully");
                        loadUsers();

                        // Clear inputs
                        $("#fullnameInput").val("");
                        $("#usernameInput").val("");
                        $("#emailInput").val("");
                        $("#passwordInput").val("");
                        $("#phoneInput").val("");
                        $("#addressInput").val("");
                        $("#avatarInput").val("");
                        $("#roleSelect").val("User");
                    },
                    error: function (xhr) {
                        const err = xhr.responseJSON?.errors || xhr.responseText;
                        showMessage("Error: " + JSON.stringify(err), true);
                    }
                });
            });

            $("#usersTable").on("click", ".btnDelete", function () {
                var id = $(this).data("id");
                if (confirm("Are you sure you want to delete this user?")) {
                    $.ajax({
                        url: "/api/Users/" + id,
                        type: "DELETE",
                        success: function () {
                            showMessage("User deleted successfully");
                            loadUsers();
                        },
                        error: function (xhr) {
                            showMessage("Error: " + xhr.responseText, true);
                        }
                    });
                }
            });

            $("#usersTable").on("click", ".btnEdit", function () {
                var id = $(this).data("id");
                var row = $(this).closest("tr");

                var currentFullname = row.find("td:nth-child(1)").text().trim();
                var currentUsername = row.find("td:nth-child(2)").text().trim();
                var currentEmail = row.find("td:nth-child(3)").text().trim();
                var currentPhone = row.find("td:nth-child(4)").text().trim();
                var currentAddress = row.find("td:nth-child(5)").text().trim();
                var currentAvatar = row.find("td:nth-child(7)").text().trim();

                var newFullname = prompt("Enter full name:", currentFullname);
                if (newFullname === null || newFullname.trim() === "") {
                    alert("Full name is required!");
                    return;
                }

                var newUsername = prompt("Enter username:", currentUsername);
                if (newUsername === null || newUsername.trim() === "") {
                    alert("Username is required!");
                    return;
                }

                var newEmail = prompt("Enter email:", currentEmail);
                if (newEmail === null || newEmail.trim() === "") {
                    alert("Email is required!");
                    return;
                }

                var newPhone = prompt("Enter phone:", currentPhone);
                if (newPhone === null) newPhone = "";

                var newAddress = prompt("Enter address:", currentAddress);
                if (newAddress === null) newAddress = "";

                var newAvatar = prompt("Enter avatar URL:", currentAvatar);
                if (newAvatar === null) newAvatar = "";

                var newPassword = prompt("Enter new password (leave blank to keep current):");
                if (newPassword === null) newPassword = "";

                var dataToSend = {
                    userId: id,
                    fullname: newFullname.trim(),
                    username: newUsername.trim(),
                    email: newEmail.trim(),
                    phone: newPhone.trim(),
                    address: newAddress.trim(),
                    avatar: newAvatar.trim(),
                };

                if (newPassword.trim() !== "") {
                    dataToSend.password = newPassword.trim();
                }

                $.ajax({
                    url: "/api/Users/" + id,
                    type: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify(dataToSend),
                    success: function () {
                        showMessage("User updated successfully");
                        loadUsers();
                    },
                    error: function (xhr) {
                        const err = xhr.responseJSON?.errors || xhr.responseText;
                        showMessage("Error updating: " + JSON.stringify(err), true);
                    }
                });
            });

            loadUsers();
        });

    </script>
}

<style>
    .page-title {
        text-align: center;
        margin-bottom: 20px;
        color: #333;
        font-weight: 700;
    }

    .btn-group {
        text-align: center;
        margin-bottom: 20px;
    }

    .btn {
        padding: 10px 18px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        transition: background-color 0.3s ease;
        user-select: none;
        margin: 0 5px;
        font-size: 16px;
    }

    .btn-primary {
        background-color: #007bff;
        color: white;
    }

    .btn-primary:hover {
        background-color: #0056b3;
    }

    .btn-success {
        background-color: #28a745;
        color: white;
    }

    .btn-success:hover {
        background-color: #1e7e34;
    }

    .users-table {
        width: 100%;
        border-collapse: collapse;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .users-table th, .users-table td {
        padding: 12px 15px;
        border: 1px solid #ddd;
        text-align: left;
    }

    .users-table thead {
        background-color: #007bff;
        color: white;
    }

    .users-table tbody tr:hover {
        background-color: #f1f7ff;
    }

    .btnEdit, .btnDelete {
        padding: 6px 12px;
        font-size: 14px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        user-select: none;
        transition: background-color 0.3s ease;
        margin-right: 5px;
    }

    .btnEdit {
        background-color: #ffc107;
        color: #212529;
    }

    .btnEdit:hover {
        background-color: #e0a800;
    }

    .btnDelete {
        background-color: #dc3545;
        color: white;
    }

    .btnDelete:hover {
        background-color: #bd2130;
    }

    .message {
        text-align: center;
        margin-top: 15px;
        font-weight: 600;
        opacity: 0;
        transition: opacity 0.5s;
        min-height: 24px;
    }

    .add-user-section {
        max-width: 600px;
        margin: 40px auto;
        background-color: #f8f9fa;
        padding: 25px 30px;
        border-radius: 12px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .add-user-section h4 {
        margin-bottom: 20px;
        font-size: 20px;
        color: #333;
        font-weight: 700;
    }

    .add-user-form {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
    }

    .form-group {
        flex: 1 1 200px;
        display: flex;
        flex-direction: column;
    }

    .form-group label {
        font-weight: 600;
        margin-bottom: 6px;
        color: #333;
    }

    .form-group input,
    .form-group select {
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
        font-size: 15px;
    }
</style>
